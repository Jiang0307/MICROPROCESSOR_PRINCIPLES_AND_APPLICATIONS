#include "xc.inc"
GLOBAL _divide_signed
    
PSECT mytext, local, class=CODE, reloc=2

_divide_signed:
    CLRF 0x010
    MOVFF WREG, TRISA  
    MOVFF WREG,0x011 ;ARG0:remainder low
    
    MOVFF 0x001 , TRISB ;ARG1:divisor
    MOVFF 0x001 , 0x012
    
    MOVLW 0x08
    MOVWF 0x020 ;COUNTER
        
    CHECK_DIVIDEND:
	BTFSC 0x011,7
	GOTO TWOS_COMPLIMENT_REMAINDER
	GOTO CHECK_DIVISOR
	    
    TWOS_COMPLIMENT_REMAINDER:
	COMF 0x011
	INCF 0x011
	GOTO CHECK_DIVISOR
	
    CHECK_DIVISOR:
	BTFSC 0x012,7
	GOTO TWOS_COMPLIMENT_DIVISOR
	GOTO LOOP
	
    TWOS_COMPLIMENT_DIVISOR:
	COMF 0x012
	INCF 0x012
	GOTO STEP_1
	
    STEP_1:
	RLCF 0x011
	RLCF 0x010
	BCF 0x011,0
    LOOP:
	MOVFF 0x012,WREG
	SUBWF 0x010,F
	BN REMAINDER_LESS_THAN_ZERO
	
	RLCF 0x011
	RLCF 0x010
	BSF 0x011,0
	GOTO CHECK_CONTINUE
	
    REMAINDER_LESS_THAN_ZERO:
	MOVFF 0x012,WREG
	ADDWF 0x010,F
	RLCF 0x011
	RLCF 0x010
	BCF 0x011,0
	GOTO CHECK_CONTINUE

    CHECK_CONTINUE:
	DECF 0x020
	BNZ LOOP
	GOTO QUOTIENT_SIGN

    QUOTIENT_SIGN:
	RRCF 0x010 ;REMAINDER
	BCF 0x010,7
	
	MOVFF TRISA,WREG
	XORWF TRISB,W
	BTFSC WREG,7
	GOTO QUOTIENT_NEGATIVE
	GOTO REMAINDER_SIGN
    QUOTIENT_NEGATIVE:
	COMF 0x011
	INCF 0x011
	GOTO REMAINDER_SIGN
	
    REMAINDER_SIGN:
	BTFSC TRISA,7
	GOTO REMAINDER_NEGATIVE
	GOTO TERMINATE
    REMAINDER_NEGATIVE:
	COMF 0x010
	INCF 0x010
	GOTO TERMINATE
    
    TERMINATE:
	BCF 0x010,4
	BCF 0x010,5
	BCF 0x010,6
	BCF 0x010,7
	
	MOVFF 0x010,0x001
	MOVFF 0x011,0x002
	NOP
	RETURN
	
	